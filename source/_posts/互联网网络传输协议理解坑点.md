---
title: 互联网网络传输协议理解坑点
date: 2019-05-25 19:53:48
categories:
- 技术
tags:
- 网络
- 计算机原理
keywords: 网络,计算机原理,HTTP,HTTPS,TCP,UDP,Socket,套接字,IP,NAT
---

配图耗费经历和时间太大，尤其时间。我是懒人，都是文字说明。

备注：网络协议博大精深，是整个互联网的根基。本人游于表层，不敢妄语，有错请指正。

#### 理解网络协议之问答篇

说明：问题是真问题，答案却是要点回答。部分回答不涉及详细原理。详细原理可根据要点自行查阅。

问：网络分层是什么样的？
答：那我们肯定是要闭着眼睛说出详细说出7层和5层网络模型的名字和对应的协议名称的，如网络层，ICMP协议等。理解网络数据交互过程中所有层所做的努力，理解网络分层含义。可以有下层没上层，但是不能有上层没下层。

问：DNS协议的用途和解析方式是什么样的？
答：所有应用层层面的数据，如果需要进行网络传输，必定需要ip地址这个核心参数。没有ip地址的包，是不可能发出去的，都过不了网卡。因为网卡不知道要把这个包传到哪里去。而ip地址人类很难记忆，所以很多服务都是通过域名进行访问。域名是比较方便记忆，但是网络又不认，因为网络无法根据域名进行数据传输，即域名没有定位功能。所以所有的应用层的域名访问，都需要DNS协议解析成ip地址后才能够封包发送，ip有定位功能。如果一个应用层服务直接通过ip地址访问另一个服务，那么是完全不用DNS做一次ip地址解析的。我们的域名是需要从特定的服务商进行购买，在服务商处会进行ip地址的配置。而DNS协议的根据就是层层服务商解析，问根域，返回顶级域，问顶级域，返回权威域，这样通过`.com`、`.cn`等不同服务商的判断，最终落实并返回一个确定的ip地址。DNS协议是系统层级的操作，应用层无需关心，系统通过DNS协议拿到ip地址后会给到应用层，然后应用层将ip地址传递到传输层进行网络数据封包。为了效率问题，系统会进行DNS的缓存以加快解析速度，并且还会设置有效期以较少误差。比较例外的是hosts文件。在这里配置的信息具有第一优先级，系统如果在hosts中找到了对应的域名和ip地址的映射，则不再进行DNS请求而直接返回映射数据。

<!-- more -->
问：ping和ICMP是怎么样的关系？
答：ICMP是网络层协议，ping是对ICMP的应用层实现。ICMP和IP协议属于同一层。ICMP工作是判断网络环境，通过返回包的时间、状态等确定网络复杂度。ping使用了ICMP的“查询报文”功能，根据返回包的时间和状态等，判断当前主机是否可以访问及延时等信息。ICMP还有一个功能是“差错报文”，Traceroute是对该功能的应用。ping出去的包，是不过传输层的，即直接过滤TCP和UDP，到达网络层封包然后通过下层协议及网卡将数据发送出去。之所以不过传输层，是因为过它们没有实际用途，他们还会影响到IMCP的核心功能即网络判断。如：如果过TCP，那么有三次握手等，本身判断网络包状态和三次握手没有关系，TCP的稳定传输会导致所有包都能有顺序的抵达终点，完全背离了ICMP的初衷。应答方，在IMCP层就会返回应答数据，也不会在上报到传输层。所以传输层全程都不干涉到。

问：DHCP用途是什么？是怎么实现的？
答：DHCP即动态主机配置协议，就是用来动态配置IP的。要想能够联网，不管局域网还是外网，都需要IP。而电脑或者手机进行网络配置的时候，不仅仅需要配置IP，还需要配置子网掩码和网关。又一个不对，网络就白配了。为了方便，可以通过DHCP协议，动态的获取IP、子网掩码、网关等重要信息。当我们连接到一个新的WIFI后，设备首先广播信息，将自己的mac地址及默认ip 0.0.0.0还有UDP端口发送出去，因为这个时候设备还没有ip地址，所以不知道发给谁，只能广播。然后网络服务也会通过广播的方式将ip等信息广播出来，广播信息里面有设备的mac地址（牵涉到mac地址的用途问题了）。设备拿到这个信息后，依旧通过ip 0.0.0.0回复给网络服务，说明该ip及相关配置信息没有问题，自己确认使用。然后网络服务给予ack回执，说明确认信息欢迎加入该网络。后面设备均使用网络服务分配的ip地址进行网络数据传输了。DHCP还会设置有效期，设备需要主动联系网络服务进行有效期的续签。比如10个小时的有效期，那么在有效期过去一半（50%），即5个小时的时候，设备会主动给网络服务发送续签的消息包，根据收到的ack回执里的信息更新本地配置，如新的有效期等。

问：一个数据包，没有端口，还能够通过网卡发出去吗？
答：端口是传输层所使用的，一个数据包没有端口，一样是可以发出去的。但是不能没有ip地址和mac地址。这两个缺少了，网卡那边就过不去。

问：
答：

问：
答：

问：
答：

问：
答：

问：
答：

问：TCP的三次握手，是怎么进行的？和Socket有什么关系？
答：TCP三次消息通话的详细流程一定要清晰的，如bind、connect等等，并且知道客户端在第二次握手的时候已经确定连接并且可以发送数据（也叫抢跑）。TCP的三次握手，根本目的是为了建立一个稳定的连接。这个连接并不是客户端和服务器之间有一条通道，而是客户端和服务器端建立稳定的套接字。每个连接，客户端都会有一个套接字对应这个连接，服务器端也是一样。因为服务器端一对多的关系，所以服务器端可以有成千上万甚至数十万个套接字（理论上限很高，因为Socket也是文件，文件打开需要耗费资源，所以实际上限远远低于理论上限）。每个套接字里面包含客户端ip、客户端port、服务器端ip、服务器端port四个重要信息。只有一方套接字还在，一方就可以通过这个套接字给另一方发送消息，即使对方可能收不到消息了（对方关闭服务等原因导致对方已经不存在等）。所以TCP的三次握手，目的是为了建立一套稳定的连接，而该稳定连接的建立，是建立在Socket套接字的基础上。如果三次握手还没有成功，这个套接字就不是完备的套接字，即连接中状态。通过三次握手的套接字是连接状态，即established状态。

问：TCP三次握手的时候，有没有网络层参与？
答：如果对网络分层模糊，很难理解该问题的意思，会感到模糊并思考该问题表达什么意思。TCP三次握手，是传输层的问题。那么传输层在进行数据握手数据传输的时候，一定要进行网络包的传送和接收。而网络包的传输，一定需要经过网络层、链路层、物理层，没有这些层，只有传输层的端口，这个包是发不出去的。所以TCP三次握手还好，四次挥手也好，HTTPS的SSL安全建立也好，一定都是需要有下层才能够发包的。即网络数据包可以有下层没有上层，但不能有上层没有下层。

问：TCP和UDP的不同？
答：这真是一个可大可小的问题。但是如果简单的回答TCP比UDP多了稳定的连接状态，应该不会让人满意的。
下面我说出我对TCP和UDP的理解。
首先，我们一个TCP或者UDP的网络请求包，在经过传输层封包后，后面就全部都是一样的了。
一样经过网络层，经过链路层，通过网卡把包发送出去，到集线器进行以太网数据传输，通过交换机，再通过路由器，通过中继器加强信号，通过防火墙...大家可以看到，TCP和UDP仅仅是数据包传输过程中的一角，根本不是大的角色。而这两个两角色，对外面大的世界是产生不了多大影响的，或者说没有影响。TCP的包，还是UDP的包，其他层都是不管的，对于其他层来说，都是包。
我们在乎的问题是数据传输，如果一个数据，可以biu的一下子就可以传递到另一方，那还需不需要有TCP呢？比如，我们一张图片，1M大小，如果这1M大小，可以通过一个包传递到云存储去，那还需要TCP干嘛呢？毕竟UDP我们也可以根据是否有回执来判断这个图片是否发送成功了。如果回执一段时间没有回来，那我们就重发嘛。
而我们之所以需要TCP，根本原因不还是这个1M的图片，不能一个包直接发送过去，因为包定义最大1500个字节，其中还有一些是头字段。因为一个数据需要拆分成很多个包发送，所以需要关注顺序和丢失问题，这才引入了TCP的概念。
UDP做了什么事情？把数据封包后通过下层再次封包之后发出去。发成功了吗？不管，如果应用层要管请自行根据超时判断。发失败了会重发吗？不管，如果应用层要管的话请自行重发。
所以你发现了没有？如果我们把1M的图片二进制流，分割成1000字节大小，共计约1000个包，我们应用层主动处理这1000个包，一定可以成功的把包发到另一方。可是这样完美吗？不完美。应用层需要大量的处理逻辑，难度极大，而且性能不佳，比如当前网络真的比较卡，应用层很多次重发都将是无效的。比如服务器网卡缓冲区因为应用层没有及时消化数据，已经满了，这个时候发再多数据根本就是失败的，服务器的网卡缓冲区装不下更多数据了啊。
So，这个时候才是伟大的TCP出场的时候。TCP出场，一口气做了这五件大事：通道连接、丢包控制、流量控制、顺序控制、拥堵控制。大家对照上面的说明可以理解，TCP是啥？不就是另一个对UDP补充的升级版协议嘛。TCP把UDP不足的地方，通过另一个协议，全部解决了。
本身，我们需要应用层为了UDP的不足做全量维护，而TCP，通过协议层面，直接帮我们做了这些事情。我们再也不用管数据发送成功不成功的问题了，因为TCP的重发可以帮我们处理的很好。
So，TCP和UDP有啥不同？
1. 他们只是在数据传输链里面很小的一环，他们影响不了传输过程。
2. UDP的不足就是TCP的补充。他们之间没有关系，是两套协议，但是，TCP却完美补充了UDP的先天不足。
3. TCP是万能的而UDP一文不值？瞎说！很多场景，根本不需要TCP的高稳定性，因为高稳定性带来的代价很大。而UDP轻量，性能很高。比如流媒体直播场景，丢一桢没啥所谓，但是因为丢了一桢而不断重发堵塞剩下的桢和网络通道，罪过可就大了。
4. 高稳定性用TCP，高性能用UDP，善长不同。
5. 但是最终我们一定要能够理解，产生TCP和UDP两个不同协议的根本原因，在于网络包大小只能小于1500字节。如果一个包能够有1M大小，那还要TCP这么复杂的处理流程干嘛呢？而TCP和UDP的表现不同，只是两个协议的维护方式不同。

问：传输层、网络层、Mac层（链路层）各自填补了哪些重要信息？
答：传输层填补了端口号。网络层填补了IP地址。链路层填补了Mac地址。
为什么需要端口号？因为操作系统需要根据端口号，将网卡缓冲区里接收到的数据通知到应用层。
为什么需要IP地址？因为IP地址才有定位功能，有了IP地址，数据包才能够发到指定的一台公网计算机上。
为什么需要Mac地址？因为IP地址具有定位功能，能够定位到一台公网主机上。但是在定位过程中，不全是公网，过路由器的时候，因为IP地址个数限制，很多时候都是一个网段的内网，而内网就需要Mac地址来进行通信了。
这里需要特别注明一点，IP地址和Mac地址，在数据传输过程中是必不可少的，但是端口号却不是必须的。毕竟端口牵涉到传输层，而不是所有的数据包都过传输层。比如ping使用的ICMP。

问：HTTP和TCP的关系？
答：你能说明他们是巴基斯坦和卡巴斯基的关系，并且听说过他们二者之间的Socket纽扣。

问：HTTPS和HTTP的不同，HTTPS的实现原理是怎么样的？（越详细越好）
答：

问：IP的用途和原理？
答：你能说明根据DNS解析IP的过程及原理，知道公网IP和私有IP的联系，知道网络号、主机号、子网掩码，听说及了解IP在网络传输过程中的重要性。

知道一个网络请求的生命周期，从DNS多层解析拿到IP地址，到申请套接字，到三次握手连接套接字通道，到网络五层协议分层原理，到网卡进行二进制包传输，到网卡发出光信号传输数据，到集线器进行以太网数据传输，到交换机进行以太网数据传输，到路由器根据IP地址进行跨子网数据传输，到中继器进行光信号的增强防止波形消耗，到经历多个路由器节点的NAT规则，到防火墙根据包的包头进行的各种控制处理，到服务器的网卡收到数据包，到服务器的五层协议数据解析，到服务器套接字，到数据缓冲区，到应用程序处理，然后一个大折回通过网络返回用户请求数据。

上面每一个知识点，都是一个学科了，一个产业链，甚至一个专家可能需要多年进行研究的点。

上面一套流程，需要在脑海里绘制出来，一来可以和别人撕逼了，二来已经能够通过网络知识，分析或者解决一些网络问题了。



#### TCP和UDP到底是什么关系？



#### HTTP/S和TCP又是什么关系？


#### 套接字是什么东西？




#### IM里面的Socket通信指的是什么？