---
title: IM 心跳是要解决什么问题
date: 2020-02-04 16:45:22
categories:
- 技术
tags:
- 网络
keywords: Socket,IM,心跳,心跳包,间隔
---

![heart](https://s2.ax1x.com/2020/03/11/8EZsVx.jpg)

本质：
1. 维系长链接
2. 保持高可用状态

遇到的问题：
1. 移动端网络波动很大（电梯进出，网络切换等）
2. NAT超时后映射会销毁，中断通路
3. 企业等防火墙会在一段时间后关闭网络包传输。

用处：
1. 服务器处理在线量，做数据统计
2. 消息及时在线推送
3. 可以让服务器端尽快感知到连接的变化，清理socket资源
4. 让客户端尽快重连，保持通路

处理：
1. 移动端隔段时间发送心跳，服务器判断长时间没有心跳则销毁socket等资源
2. TCP Keepalive处理，动态处理探活参数（不需要应用层参与，只能判断内核层是否正常响应，但业务层是否崩溃不可知，只能感知网络正常）
3. 应用层心跳，30s、1分钟、2分钟、4分钟都有。有动态心率和固定心率。
4. TCP Keepalive和应用层心跳配合，一个用来判断网络，一个用来判断业务服务器，对socket中断进行debug。
5. 智能心跳。频繁心跳会导致电量、流量等浪费，智能心跳可以平衡 NAT 超时和资源节约。智能心跳根据网络环境自动调整心跳方案如心率等，通过使用二分法等算法方案逐步逼近NAT超时临界点。

```
后面想写一片介绍Socket的文章，把现在想到的部分内容放在这里做备忘。

我们谈论的Socket更多是指基于TCP或者UDP实现的IM即时通讯，比如微信、QQ等。客户端和服务器各自将通过对方的IP和端口号绑定到一个文件里面。
Socket本来是一个文件，互联网上两个终端(比如客户端和服务器)如果需要通讯，就需要知道对方的IP和Port(端口)。那知道对方的IP和Port后存储在哪里呢？就是一个文件里面。这个文件就是Socket。更接地气的说，叫套接字，Socket翻译过来就是套接字。
服务器通过HTTP回复给客户端的数据，以及微信如何找到接收消息的终端，都是通过读取套接字拿到对方的IP和Port，然后才能发送消息。还有TCP的三次握手，就是在不断改变套接字里面的相关字段，这发生在connect阶段。所以套接字的用途非常大，用来标记通话对象。
刚才说的connect就是Socket向外的一个接口。。。啥？一个文件提供接口？
真是小孩没娘，说来话长。互联网本来就是数据的传输。传输层本来有专门的协议负责数据传输，就是TCP它们。可是应用层HTTP怎么和TCP对接呢？就需要很多个接口。而这些接口处于一个库中，没错，这个库就叫做Socket库。Socket库提供了write、read接口用来从缓冲区读取数据，提供了connect接口用来建立连接（没错，TCP本来就是一个传输通道，握手握了几次TCP哪里知道，就是connect接口在处理那几次握手顺带把握手过程写到了套接字文件中），此外，Scoket还有很多其他接口如gethostbyname(域名解析用的，没错，域名转成ip是Scoket提供的接口完成的)、close等。
所以，到这里，Socket已经有两层含义了，一个是Socket库，用来和传输层通讯用的。还有一个是套接字，用来标记和存储通话对象用的。
而且，这两层含义，都使用在各类应用层协议中。比如HTTP或者RTMP，要数据传输，肯定要走一遍Socket库，才有write接口发送数据，也肯定要建立套接字，才能标记对方。
```
___
